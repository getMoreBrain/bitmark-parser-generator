<!DOCTYPE html>
<head>
  <title>bonaroo-able test</title>
  <script src="../../dist/browser/index.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const { BitmarkJson, StringBitmapMarkupGenerator, BitmarkParser } = window.bitmarkGenerator;
      console.log('bitmark-generator Browser Test');

      const defaultJson = JSON.parse(`[
    {
      "bitmark": "[.cloze][%cl1]I am coffee toast[_cloze][!noun ain hint for the second gap][?1 or 2][_gap text][!verb]",
      "bit": {
        "type": "cloze",
        "format": "bitmark--",
        "body": "I am coffee toast{0}",
        "item": "cl1",
        "hint": "",
        "isExample": false,
        "example": "",
        "placeholders": {
          "{0}": {
            "type": "gap",
            "item": "",
            "solutions": [
              "cloze",
              "gap text"
            ],
            "hint": "1 or 2",
            "instruction": "verb",
            "isCaseSensitive": true,
            "isExample": false,
            "example": ""
          }
        }
      }
    }
    ]`);
      const defaultJsonTxt = JSON.stringify(defaultJson, null, 2);

      const dom = {
        json: document.getElementById('input'),
        bitmark: document.getElementById('output'),
        toBitmark: document.getElementById('toBitmark'),
        toJson: document.getElementById('toJson'),
      };

      dom.json.value = defaultJsonTxt;

      const jsonToBitmark = async () => {
        console.log('Converting JSON to Bitmark');
        try {
          // Get the JSON from the input box
          const json = JSON.parse(dom.json.value);

          // Convert the bitmark JSON to bitmark AST
          const ast = BitmarkJson.toAst(json);
          console.log(ast);

          // Generate markup code from AST
          const generator = new StringBitmapMarkupGenerator({
            explicitTextFormat: false,
          });

          const res = await generator.generate(ast);

          dom.bitmark.value = res;
        } catch (e) {
          dom.bitmark.value = JSON.stringify(e, Object.getOwnPropertyNames(e), 2);
          console.log(e);
        }
      };

      const bitmarkToJson = async () => {
        console.log('Converting Bitmark to JSON');
        try {
          // Get the Bitmark from the input box
          const bitmark = dom.bitmark.value;

          const parser = new BitmarkParser();

          const jsonStr = parser.parse(bitmark);
          const json = JSON.parse(jsonStr);

          // Convert the bitmark JSON to bitmark AST
          // const ast = BitmarkJson.toAst(json);
          // console.log(ast);

          dom.json.value = JSON.stringify(json, null, 2);
        } catch (e) {
          dom.json.value = JSON.stringify(e, Object.getOwnPropertyNames(e), 2);
          console.log(e);
        }
      };

      dom.toBitmark.addEventListener('click', jsonToBitmark);
      dom.toJson.addEventListener('click', bitmarkToJson);
    });
  </script>
  <style>
    .wrapper {
      display: flex;
      justify-content: space-between;
    }
    .input {
      width: 48vw;
      height: 98vh;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    .buttons {
      width: 3vw;
      height: 98vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 60px;
    }
    .output {
      width: 48vw;
      height: 98vh;
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <textarea id="input" class="input"></textarea>
    <div class="buttons">
      <button id="toBitmark">==></button>
      <button id="toJson"><==</button>
    </div>
    <textarea id="output" class="output"></textarea>
  </div>
</body>
