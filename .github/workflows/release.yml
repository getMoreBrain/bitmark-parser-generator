# .github/workflows/release.yml
# This workflow will build, test, generate release notes using Claude, then trigger the publish a new release to NPM
# Uses composite actions for modular, reusable components

name: Release

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write # Required for OIDC to NPM
  pull-requests: read
  repository-projects: write # Required for updating GitHub Projects status

jobs:
  branch-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure release runs on main
        run: |
          if [ "${GITHUB_REF}" != "refs/heads/main" ]; then
            echo "::error::Release workflow can only run from main (got ${GITHUB_REF})"
            exit 1
          fi

  release:
    runs-on: ubuntu-latest
    needs: branch-guard
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "24.x"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Get version from package.json
        id: pkg
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION (expected X.X.X)"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        run: |
          if git rev-parse "v${{ steps.pkg.outputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag v${{ steps.pkg.outputs.version }} already exists!"
            exit 1
          fi

      - name: Get previous tag and date
        id: prev_tag
        env:
          CURRENT_VERSION: ${{ steps.pkg.outputs.version }}
        run: |
          PREV_TAG=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

          if [ -n "$PREV_TAG" ]; then
            PREV_DATE=$(git log -1 --format=%aI "$PREV_TAG")
            echo "date=$PREV_DATE" >> $GITHUB_OUTPUT

            # Version comparison check
            CLEAN_PREV=${PREV_TAG#v}
            HIGHEST=$(printf "%s\n%s" "$CURRENT_VERSION" "$CLEAN_PREV" | sort -V | tail -n 1)

            if [ "$CURRENT_VERSION" != "$HIGHEST" ] || [ "$CURRENT_VERSION" == "$CLEAN_PREV" ]; then
               echo "::error::New version $CURRENT_VERSION must be greater than previous version $CLEAN_PREV"
               exit 1
            fi
          fi

      # Composite action: Collect PR and commit data
      # Uses GMB_PROJECT_TOKEN to access cross-repo linked issues (e.g., cosmic issues)
      - name: Collect release data
        id: release_data
        uses: ./.github/actions/collect-release-data
        with:
          previous-tag: ${{ steps.prev_tag.outputs.tag }}
          previous-date: ${{ steps.prev_tag.outputs.date }}
          github-token: ${{ secrets.GMB_PROJECT_TOKEN }}

      # Composite action: Generate release notes with Claude
      - name: Generate release notes
        id: claude
        uses: ./.github/actions/generate-release-notes
        with:
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          tag-name: ${{ steps.pkg.outputs.tag }}
          previous-tag: ${{ steps.prev_tag.outputs.tag }}
          pr-list: ${{ steps.release_data.outputs.pr-list }}
          commit-log: ${{ steps.release_data.outputs.commit-log }}
          repository-url: "https://github.com/${{ github.repository }}"

      # Upload debug artifacts on failure
      - name: Upload Claude API artifacts for debugging
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: claude-api-debug
          path: |
            payload.json
            response.json
          retention-days: 7

      - name: Publish
        run: npm publish --access public

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.pkg.outputs.tag }}
          name: ${{ steps.pkg.outputs.tag }}
          body: ${{ steps.claude.outputs.notes }}
          draft: false

      # Composite action: Comment on PRs and issues
      # Uses GMB_PROJECT_TOKEN to comment on cross-repo issues (e.g., cosmic issues)
      - name: Comment on PRs and Issues
        continue-on-error: true
        uses: ./.github/actions/comment-on-release
        with:
          github-token: ${{ secrets.GMB_PROJECT_TOKEN }}
          tag-name: ${{ steps.pkg.outputs.tag }}
          pr-urls: ${{ steps.release_data.outputs.pr-urls }}
          linked-issue-urls: ${{ steps.release_data.outputs.linked-issue-urls }}
          commit-issue-urls: ${{ steps.release_data.outputs.commit-issue-urls }}

      # Composite action: Update issue status in GitHub Projects
      - name: Update issue status to Testing on Cosmic
        continue-on-error: true
        uses: ./.github/actions/update-project-status
        with:
          github-token: ${{ secrets.GMB_PROJECT_TOKEN }}
          org-name: getMoreBrain
          project-number: "3"
          target-status: "Testing on Cosmic ðŸ¥‚"
          linked-issue-urls: ${{ steps.release_data.outputs.linked-issue-urls }}
          commit-issue-urls: ${{ steps.release_data.outputs.commit-issue-urls }}

      - name: Trigger bitmark API pipeline
        continue-on-error: true
        run: |
          curl -X POST \
            --connect-timeout 10 \
            --max-time 30 \
            -H "Content-Type: application/json" \
            -H "Circle-Token: ${{ secrets.CIRCLE_TOKEN }}" \
            https://circleci.com/api/v2/project/github/getMoreBrain/bitbook-api/pipeline

      - name: Purge jsdelivr cache
        continue-on-error: true
        run: |
          curl -X GET \
            --connect-timeout 10 \
            --max-time 30 \
            https://purge.jsdelivr.net/npm/@gmb/bitmark-parser-generator@latest/dist/browser/bitmark-parser-generator.min.js
