# .github/workflows/release.yml
name: Release

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write # Required for OIDC to NPM
  pull-requests: read

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "24.x"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Get version from package.json
        id: pkg
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION (expected X.X.X)"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        run: |
          if git rev-parse "v${{ steps.pkg.outputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag v${{ steps.pkg.outputs.version }} already exists!"
            exit 1
          fi

      - name: Get previous tag and date
        id: prev_tag
        env:
          # PASS THE VERSION HERE so it is available as $CURRENT_VERSION
          CURRENT_VERSION: ${{ steps.pkg.outputs.version }}
        run: |
          PREV_TAG=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | head -n 1)
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

          if [ -n "$PREV_TAG" ]; then
            PREV_DATE=$(git log -1 --format=%aI "$PREV_TAG")
            echo "date=$PREV_DATE" >> $GITHUB_OUTPUT

            # --- VERSION COMPARISON CHECK ---
            CLEAN_PREV=${PREV_TAG#v}

            # Sort versions; if CURRENT_VERSION is not the last (highest), fail.
            HIGHEST=$(printf "%s\n%s" "$CURRENT_VERSION" "$CLEAN_PREV" | sort -V | tail -n 1)

            if [ "$CURRENT_VERSION" != "$HIGHEST" ] || [ "$CURRENT_VERSION" == "$CLEAN_PREV" ]; then
               echo "::error::New version $CURRENT_VERSION must be greater than previous version $CLEAN_PREV"
               exit 1
            fi
          fi

      - name: Get merged PRs since last release
        id: prs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ steps.prev_tag.outputs.date }}" ]; then
            PRS=$(gh pr list \
              --state merged \
              --base main \
              --search "merged:>${{ steps.prev_tag.outputs.date }}" \
              --json number,title,labels,author \
              --jq '.[] | "- PR #\(.number): \(.title) (@\(.author.login)) [labels: \([.labels[].name] | join(", "))]"')
          else
            PRS=$(gh pr list \
              --state merged \
              --base main \
              --limit 30 \
              --json number,title,labels,author \
              --jq '.[] | "- PR #\(.number): \(.title) (@\(.author.login)) [labels: \([.labels[].name] | join(", "))]"')
          fi
          echo "list<<EOF" >> $GITHUB_OUTPUT
          echo "$PRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get commits since last release
        id: commits
        run: |
          if [ -n "${{ steps.prev_tag.outputs.tag }}" ]; then
            COMMITS=$(git log ${{ steps.prev_tag.outputs.tag }}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -30)
          fi
          echo "log<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate release notes with Claude
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # FIX: Pass data as env vars to prevent script injection
          TAG_NAME: ${{ steps.pkg.outputs.tag }}
          PR_LIST: ${{ steps.prs.outputs.list }}
          COMMIT_LOG: ${{ steps.commits.outputs.log }}
          PREV_TAG: ${{ steps.prev_tag.outputs.tag }}
        run: |
          # 1. Construct Prompt using Environment Variables (Safer)
          # We use a variable for the template to keep the prompt construction clean
          TEMPLATE=$(cat <<'TEMPLATE_END'
          [1-2 sentence summary of this release]

          ## âœ¨ New Features
          - [Feature description] (Issue #issue, PR #PR)

          ## ðŸ› Bug Fixes
          - [Fix description] (Issue #issue, PR #PR)

          ## ðŸ“š Documentation
          - [Documentation change] (Issue #issue, PR #PR)

          ## ðŸ”§ Maintenance
          - [Maintenance item] (Issue #issue, PR #PR)

          **Contributors**: {list of GitHub usernames}
          **Full Changelog**: {project url}/compare/PREV_TAG...TAG_NAME
          TEMPLATE_END
          )

          # Replace placeholders in template
          TEMPLATE="${TEMPLATE//PREV_TAG/$PREV_TAG}"
          TEMPLATE="${TEMPLATE//TAG_NAME/$TAG_NAME}"

          # Construct the full prompt text safely
          PROMPT="Generate release notes for version $TAG_NAME of @gmb/bitmark-parser-generator.

          ## Merged Pull Requests:
          $PR_LIST

          ## Commits:
          $COMMIT_LOG

          ## Instructions:
          - Use PR titles/labels as primary source
          - Re-write from user perspective
          - Output ONLY the release notes markdown following this template:

          $TEMPLATE"

          # 2. JSON Escape
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)

          # 3. Call Claude API (Fail fast on error)
          RESPONSE=$(curl -s -f https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-3-5-sonnet-latest\",
              \"max_tokens\": 8192,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": $ESCAPED_PROMPT
              }]
            }") || { echo "::error::API request failed"; exit 1; }

          # 4. Parse Response
          RELEASE_NOTES=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -z "$RELEASE_NOTES" ]; then
            echo "::error::Failed to parse release notes"
            exit 1
          fi

          # 5. FIX: Use Random Delimiter for GitHub Output
          # This prevents "EOF" inside the notes from breaking the workflow
          DELIMITER=$(openssl rand -hex 8)

          echo "notes<<$DELIMITER" >> $GITHUB_OUTPUT
          echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
          echo "$DELIMITER" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.pkg.outputs.tag }}
          name: ${{ steps.pkg.outputs.tag }}
          # FIX 1: Updated to match the ID from the previous step (.notes instead of .result)
          body: ${{ steps.claude.outputs.notes }}
          draft: true
